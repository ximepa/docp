{% extends 'base.html' %}
{% load staticfiles %}

{% block extra_head %}
    <link rel='stylesheet' type='text/css' href='{% static 'claim/css/fullcalendar/fullcalendar.css' %}' />
    <link rel='stylesheet' type='text/css' href='{% static 'claim/css/fullcalendar/fullcalendar.print.css' %}' />
    <script type='text/javascript' src='{% static 'claim/js/fullcalendar/fullcalendar.js' %}'></script>
    <script type='text/javascript' src='{% static 'claim/js/fullcalendar/jquery-ui.custom.min.js' %}'></script>
    <script type='text/javascript' src='{% static 'js/jquery.util.js' %}'></script>
    <script type='text/javascript' src='{% static 'js/jquery.form.js' %}'></script>
    <script type='text/javascript' src='{% static 'js/jquery.rpc.js' %}'></script>
    <script type='text/javascript' src='{% static 'js/ajax-csrf.js' %}'></script>
    <script type='text/javascript' src='{% url 'api' %}'></script>
{% endblock %}
{% block scripts %}
<script language="javascript">

    $(document).ready(function() {

        var event_form = {
                ajax_init: function () {
                    $('#rpc-event-set-js').ajaxForm({
                        type: 'RPC',
                        api: {
                            submit: CalendarApi.events_set
                        },
                        success: function (data, rpc_response, $form) {
                            if (data.success) {
                                $('#calendar').fullCalendar('refetchEvents');
                                $('#add-event-popup').modal('hide');
                            } else {

                            }
                        },
                        error: function (data, rpc_response, $form) {

                        },
                        beforeSubmit: function (formData, $form, options) {

                        }
                    });
                },
                rollback: null
            };

        var calendar = {
            events_get: function(start, end, callback) {
                CalendarApi.events_get(start, end, function(data) {
                    callback(data);
                });
            },

            events_update_form: function (event, start, end) {
                if (!event) {
                    // new slot creation. calendar select event
                    $("#event_start").val($.fullCalendar.formatDate(start, "yyyy-MM-dd HH:mm:ss"));
                    $("#event_end").val($.fullCalendar.formatDate(end, "yyyy-MM-dd HH:mm:ss"));
                    $("#event_instance_id").val('');
                } else {
                    // slot update. calendar eventClick event
                    $("#event_start").val($.fullCalendar.formatDate(event.start, "yyyy-MM-dd HH:mm:ss"));
                    $("#event_end").val($.fullCalendar.formatDate(event.end, "yyyy-MM-dd HH:mm:ss"));
                    $("#event_instance_id").val(event.id);
                }
            }
        };

        $('#calendar').fullCalendar({
            header: {
                left: 'prev,next today tomorow',
                center: 'title',
                right: 'month,basicWeek,basicDay'
            },
            defaultView: 'basicWeek',
            aspectRatio: 1.4,
            weekends: true,
            firstDay: 1,
            editable: true,
            events: function(start, end, callback){
                CalendarApi.events_get(start, end, callback);
            },
            eventRender: function (event, element, view) {
            },
            eventDrop: function (event, dayDelta, minuteDelta, allDay, revertFunc, jsEvent, ui, view) {
                calendar.events_update_form(event);
                $('#rpc-event-set-js').submit();
            },
            eventResize: function (event, dayDelta, minuteDelta, revertFunc, jsEvent, ui, view) {
                calendar.events_update_form(event);
                $('#rpc-event-set-js').submit();
            },
            eventClick: function(calEvent, jsEvent, view) {
                $('#add-event-popup').modal('show');
                calendar.events_update_form(calEvent);
            }
        });

        console.log('ajax init')
        event_form.ajax_init();
        console.log('ajax init ok')

    });
</script>
{% endblock %}
{% block content %}
    {% csrf_token %}
    <div class="row">
        <div class="col-xs-10 col-md-8 col-xs-offset-8 col-md-offset-2">
            <h1>Виберіть пунк для перегляду</h1>
            <p>{{ text }}</p>
            <div id='calendar'></div>
        </div>
    </div>
{% endblock %}

{% block modals %}
    {{ super }}
        <div class="modal hide fade add-event-popup" id="add-event-popup">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>Add event</h3>
            </div>
            <form id="rpc-event-set-js">{% csrf_token %}
            <input type="hidden" name="start" id="event_start">
            <input type="hidden" name="end" id="event_end">
            <input type="hidden" name="instance_id" id="event_instance_id">
            <div class="modal-footer">
                <button class="btn btn-info bt-submit-popup" title="Save">Save</button>
                <a class="btn bt-close-popup" title="Cancel">Cancel</a>
                <a class="btn btn-danger delete-action" title="Delete">Delete</a>
            </div>
            </form>
        </div>
{% endblock %}